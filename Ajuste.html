<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Ajuste de Dados - AsaDelta</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body { background-color: #f0f2f5; }
        .diff-old { color: #dc3545; text-decoration: line-through; font-size: 0.85em; }
        .diff-new { color: #198754; font-weight: bold; }
        .card-header { background-color: #ffc107; color: #000; font-weight: bold; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

    <div class="container mt-5 mb-5">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-tools"></i> Ferramenta de Padronização de Banco de Dados</span>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>Regras de Ajuste:</strong><br>
                    1. <b>Telefone:</b> Remove caracteres não numéricos. Se tiver 8 ou 9 dígitos, adiciona DDD <b>51</b>. Formata para (XX) XXXXX-XXXX.<br>
                    2. <b>CPF:</b> Formata para 000.000.000-00 se tiver 11 dígitos.
                </div>

                <button class="btn btn-primary" onclick="analisarDados()" id="btnAnalisar">
                    1. Carregar e Analisar Clientes
                </button>
                
                <button class="btn btn-success ms-2" onclick="aplicarCorrecoes()" id="btnSalvar" style="display:none;">
                    2. Confirmar e Salvar Correções no Firebase
                </button>

                <div id="loading" class="mt-3 text-muted" style="display:none;">
                    <span class="spinner-border spinner-border-sm" role="status"></span> Processando...
                </div>
            </div>
        </div>

        <div class="card mt-4 shadow" id="resultadoCard" style="display:none;">
            <div class="card-header bg-white">
                Pré-visualização das Alterações (<span id="countAlteracoes">0</span> clientes precisam de ajuste)
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefone (Antes -> Depois)</th>
                                <th>CPF (Antes -> Depois)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCorrecoes"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCSo4NsaIlD9Mdfrlp-5jjxxrhcqnx5XuI",
            authDomain: "sistemaasadelta.firebaseapp.com",
            projectId: "sistemaasadelta",
            storageBucket: "sistemaasadelta.appspot.com",
            messagingSenderId: "379026766576",
            appId: "1:379026766576:web:c6d3f2b6a71e42a98f123d" 
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let listaParaCorrigir = [];

        // --- FUNÇÕES DE FORMATAÇÃO ---

        function formatarTelefone(valor) {
            if (!valor) return '';
            let nums = valor.replace(/\D/g, ''); // Remove tudo que não é número

            // Regra: Se tiver menos que 10 digitos (ex: 99999-9999), assume DDD 51
            if (nums.length === 8 || nums.length === 9) {
                nums = '51' + nums;
            }

            // Formata se tiver 10 ou 11 digitos
            if (nums.length === 11) {
                return nums.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (nums.length === 10) {
                return nums.replace(/^(\d{2})(\d{4})(\d{4}).*/, '($1) $2-$3');
            }
            
            return valor; // Se não se encaixar (ex: numero fixo estranho), retorna o original
        }

        function formatarCPF(valor) {
            if (!valor) return '';
            let nums = valor.replace(/\D/g, '');

            if (nums.length === 11) {
                return nums.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            }
            return valor;
        }

        // --- LÓGICA DA FERRAMENTA ---

        async function analisarDados() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tabelaCorrecoes').innerHTML = '';
            listaParaCorrigir = [];

            try {
                const snapshot = await db.collection('clientes').get();
                
                let html = '';
                let count = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const telOriginal = data.telefone || '';
                    const cpfOriginal = data.cpf || '';

                    const telNovo = formatarTelefone(telOriginal);
                    const cpfNovo = formatarCPF(cpfOriginal);

                    // Verifica se houve mudança
                    if (telOriginal !== telNovo || cpfOriginal !== cpfNovo) {
                        count++;
                        listaParaCorrigir.push({
                            id: doc.id,
                            telefone: telNovo,
                            cpf: cpfNovo
                        });

                        html += `
                            <tr>
                                <td>${data.nome}</td>
                                <td>
                                    ${telOriginal !== telNovo ? 
                                      `<div class="diff-old">${telOriginal}</div><div class="diff-new">${telNovo}</div>` : 
                                      telNovo}
                                </td>
                                <td>
                                    ${cpfOriginal !== cpfNovo ? 
                                      `<div class="diff-old">${cpfOriginal}</div><div class="diff-new">${cpfNovo}</div>` : 
                                      cpfNovo}
                                </td>
                                <td><span class="badge bg-warning text-dark">Pendente</span></td>
                            </tr>
                        `;
                    }
                });

                document.getElementById('tabelaCorrecoes').innerHTML = html;
                document.getElementById('countAlteracoes').innerText = count;
                document.getElementById('resultadoCard').style.display = 'block';

                if (count > 0) {
                    document.getElementById('btnSalvar').style.display = 'inline-block';
                } else {
                    alert("Todos os dados já estão padronizados! Nenhuma ação necessária.");
                }

            } catch (error) {
                console.error(error);
                alert("Erro ao buscar dados: " + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function aplicarCorrecoes() {
            if (!confirm(`Confirma a correção de ${listaParaCorrigir.length} clientes?`)) return;

            document.getElementById('loading').style.display = 'block';
            const btn = document.getElementById('btnSalvar');
            btn.disabled = true;
            btn.innerText = "Salvando...";

            let erros = 0;
            let sucessos = 0;

            // Processa um por um para garantir
            for (const item of listaParaCorrigir) {
                try {
                    await db.collection('clientes').doc(item.id).update({
                        telefone: item.telefone,
                        cpf: item.cpf
                    });
                    sucessos++;
                } catch (error) {
                    console.error("Erro no ID " + item.id, error);
                    erros++;
                }
            }

            document.getElementById('loading').style.display = 'none';
            alert(`Processo finalizado!\nSucessos: ${sucessos}\nErros: ${erros}`);
            
            // Recarrega a tela para limpar
            analisarDados();
            btn.disabled = false;
            btn.innerText = "2. Confirmar e Salvar Correções no Firebase";
            btn.style.display = 'none';
        }

    </script>
</body>
</html>